<script>
  {% if template == 'cart' %}
    const removePersonalisationCharge = (quantity) => {
      const remainingChargeItem = document.querySelector("tr.personalisation-charge .bag-qty input").value;
      let updates = {
        53479059259771: Math.abs(parseInt(remainingChargeItem) - parseInt(quantity))
      };
      fetch(window.Shopify.routes.root + 'cart/update.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({updates})
      })
        .then((response) => {
          return response.json();
        })
        .catch((error) => {
          console.error('Error:', error);
        })
    };
        
        
    if(document.querySelectorAll("tr[data-personalisation='true']")){
      document.querySelectorAll("tr[data-personalisation='true'] td.remove button.remove").forEach(remove=>{
        remove.addEventListener("click",()=>{
            if(document.querySelector("tr.personalisation-charge .bag-qty input")){
              setTimeout(()=>{
                removePersonalisationCharge(remove.getAttribute("data-total-items"));
              },100)
            }
          })
      })
    }
  {% endif %}

{% comment %} cart drawer {% endcomment %}

  const isPersonalised = (targetElement) =>{
    const dataIsPersonalised = targetElement.closest(".ajaxcart__product")?.querySelector(".cart.ajaxcart [data-is='personalised']") || false;
    if(dataIsPersonalised && (targetElement == dataIsPersonalised.closest(".ajaxcart__product").querySelector(".cart.ajaxcart .ajaxcart__qty--minus") || targetElement == dataIsPersonalised.closest(".ajaxcart__product").querySelector(".cart.ajaxcart .ajaxcart__qty--plus"))){
      console.log('isPersonalised:');
      return `${targetElement.dataset["operation"]}`;
    }
    return false;
  }
  document.body.addEventListener("click",(e)=>{
    const updateOperation = isPersonalised(e.target);
    if(updateOperation){
      document.body.classList.add("pointer-event-none")
      setTimeout(()=>{
        document.querySelector(".cart.ajaxcart a[href*='/products/personalisation']").closest(".ajaxcart__product").querySelector(`.cart.ajaxcart .ajaxcart__qty--${updateOperation}`).click();
      },5000)
      setTimeout(()=>{
        document.body.classList.remove("pointer-event-none")
      },8000)
      
    }
  })
  {% comment %} cart drawer {% endcomment %}
</script>

<style>
  tr.personalisation-charge .qty.product .qty-total .js-qty button {
    display: none;
  }
  tr.personalisation-charge .product span {
    display: none;
  }
  tr.personalisation-charge a {
    pointer-events: none;
  }
  tr.personalisation-charge .product span.variant-title {
    display: none;
  }
  .cart.ajaxcart .ajaxcart__product:has(a[href*='/products/personalisation-charge']) a {
    pointer-events: none;
  }
  .cart.ajaxcart .ajaxcart__product:has(a[href*='/products/personalisation-charge']) .ajaxcart__qty button {
    display: none;
  }
  .pointer-event-none {
    pointer-events: none;
  }
  span.ajaxcart__product-meta.mid[data-is='personalised'] {
    display: block !important;
  }
  tr .product :is(._MID_Name, ._MID_Address, ._MID_Code) {
    display: none !important;
  }
</style>
